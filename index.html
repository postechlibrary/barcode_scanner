<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 도서관 장서점검 스캐너 v1.9</title>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        /* --- 기본 스타일 (변경 없음) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container { max-width: 500px; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .scanner-area { position: relative; padding: 20px; }
        #video { width: 100%; border-radius: 10px; border: 3px solid #4CAF50; background: #333; }
        .controls { padding: 0 20px 20px; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .stats { display: flex; justify-content: space-around; padding: 15px 20px; background: #f5f5f5; border-top: 1px solid #ddd; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .stat-label { font-size: 12px; color: #666; }
        .scan-list { max-height: 300px; overflow-y: auto; padding: 20px; border-top: 1px solid #ddd; }
        .scan-item { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #4CAF50; font-family: monospace; font-size: 14px; }
        .scan-time { color: #666; font-size: 12px; }
        .settings { padding: 20px; border-top: 1px solid #ddd; background: #fafafa; }
        .setting-item { margin: 15px 0; }
        .setting-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .setting-item input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .message-box { padding: 10px; border-radius: 5px; margin: 10px 20px; display: none; }
        .error-message { background: #ffebee; color: #c62828; }
        .success-message { background: #e8f5e8; color: #2e7d32; }
        .toggle-btn { background: none; border: none; color: #2196F3; cursor: pointer; text-decoration: underline; margin: 10px 0; padding: 5px; display: block; margin-left: auto; margin-right: auto; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 10px; padding: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-content h3 { margin: 0 0 10px 0; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }

        .indicator-light { width: 20px; height: 20px; border-radius: 50%; background-color: #555; border: 2px solid #fff; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: all 0.3s ease; position: absolute; top: 50%; right: 20px; transform: translateY(-50%); }
        .light-green { background-color: #28a745; box-shadow: 0 0 15px #28a745; }
        .light-red { background-color: #dc3545; box-shadow: 0 0 15px #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="scanIndicator" class="indicator-light"></div>
            <h1>📚 도서관 장서점검 v1.9</h1>
            <p>바코드 스캐너</p>
        </div>
        <div class="scanner-area">
            <video id="video" autoplay muted playsinline></video>
        </div>
        <div class="controls">
            <button id="startBtn" class="btn btn-primary">📷 스캔 시작</button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;">⏹️ 스캔 중지</button>
            <button id="exportBtn" class="btn btn-secondary">💾 데이터 내보내기</button>
            <button id="clearBtn" class="btn btn-danger">🗑️ 목록 지우기</button>
            <button id="settingsToggleBtn" class="toggle-btn">⚙️ 설정</button>
        </div>
        <div id="errorMsg" class="message-box error-message"></div>
        <div id="successMsg" class="message-box success-message"></div>
        <div class="stats">
            <div class="stat-item"><div class="stat-value" id="totalCount">0</div><div class="stat-label">📊 총 스캔</div></div>
            <div class="stat-item"><div class="stat-value" id="validCount">0</div><div class="stat-label">✅ 유효</div></div>
            <div class="stat-item"><div class="stat-value" id="duplicateCount">0</div><div class="stat-label">🔄 중복</div></div>
        </div>
        <div id="settingsPanel" class="settings" style="display: none;">
            <div class="setting-item"><label>📝 바코드 시작 문자 (유효성 검사):</label><input type="text" id="prefixSetting" value="M" placeholder="예: M, LIB, 20"></div>
            <div class="setting-item"><label>🔢 최소 바코드 길이:</label><input type="number" id="minLengthSetting" value="8" min="1"></div>
            <div class="setting-item"><label>🔊 알림음 활성화:</label><input type="checkbox" id="soundSetting" checked></div>
            <div class="setting-item"><label>🔋 배터리 절약 모드:</label><input type="checkbox" id="batterySavingSetting" checked><small style="color: #666; display: block; margin-top: 5px;">활성화시 스캔 빈도를 줄여 발열과 배터리 소모를 방지합니다.</small></div>
        </div>
        <div class="scan-list" id="scanList"><p style="text-align: center; color: #666;">📋 스캔된 바코드가 여기에 표시됩니다</p></div>
    </div>
    <script>
        class LibraryBarcodeScanner {
            constructor() {
                this.scannedCodes = new Set();
                this.scanHistory = [];
                this.codeReader = null;
                this.mediaStream = null;
                this.lastScannedCode = '';
                this.lastScanTime = 0;
                this.scanCooldown = 2000;
                this.initializeElements();
                this.initializeEventListeners();
                this.initializeCodeReader();
            }
            initializeElements() {
                this.video = document.getElementById('video');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.settingsToggleBtn = document.getElementById('settingsToggleBtn');
                this.settingsPanel = document.getElementById('settingsPanel');
                this.scanList = document.getElementById('scanList');
                this.totalCount = document.getElementById('totalCount');
                this.validCount = document.getElementById('validCount');
                this.duplicateCount = document.getElementById('duplicateCount');
                this.errorMsg = document.getElementById('errorMsg');
                this.successMsg = document.getElementById('successMsg');
                this.prefixSetting = document.getElementById('prefixSetting');
                this.minLengthSetting = document.getElementById('minLengthSetting');
                this.soundSetting = document.getElementById('soundSetting');
                this.batterySavingSetting = document.getElementById('batterySavingSetting');
                this.scanIndicator = document.getElementById('scanIndicator');
            }
            initializeEventListeners() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.exportBtn.addEventListener('click', () => this.exportData());
                this.clearBtn.addEventListener('click', () => this.clearData());
                this.settingsToggleBtn.addEventListener('click', () => this.toggleSettings());
            }
            initializeCodeReader() {
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.CODE_39,
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.EAN_8
                ]);
                this.codeReader = new ZXing.BrowserMultiFormatReader(hints);
            }
            async startScanning() {
                try {
                    this.hideMessages();
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    this.video.srcObject = this.mediaStream;
                    this.video.onloadedmetadata = () => {
                        this.startBtn.style.display = 'none';
                        this.stopBtn.style.display = 'block';
                        this.showSuccess('📷 스캔이 시작되었습니다!');
                        this.codeReader.decodeFromVideoDevice(
                            null,
                            this.video,
                            (result, error) => {
                                if (result) this.processBarcodeResult(result.getText());
                                if (error && !(error instanceof ZXing.NotFoundException)) {
                                    console.error('스캔 오류:', error);
                                }
                            }
                        );
                    };
                } catch (e) {
                    this.showError('카메라 시작 불가: ' + e.message);
                }
            }
            processBarcodeResult(barcode) {
                const now = Date.now();
                if (barcode === this.lastScannedCode && now - this.lastScanTime < (this.batterySavingSetting.checked ? this.scanCooldown : 1000)) return;
                this.lastScannedCode = barcode;
                this.lastScanTime = now;
                const prefix = this.prefixSetting.value.trim();
                const minLen = parseInt(this.minLengthSetting.value, 10);
                if (prefix && !barcode.startsWith(prefix)) { this.handleInvalidScan(`올바르지 않은 시작 문자 (${prefix})`, barcode); return; }
                if (barcode.length < minLen) { this.handleInvalidScan(`길이 부족 (최소 ${minLen})`, barcode); return; }
                if (this.scannedCodes.has(barcode)) { this.handleInvalidScan('중복 바코드', barcode, true); return; }
                this.handleValidScan(barcode, now);
            }
            handleValidScan(barcode, now) {
                this.scannedCodes.add(barcode);
                this.scanHistory.push({ barcode, time: new Date(now) });
                this.flashIndicator('green');
                this.playSuccessSound();
                this.updateScanList();
                this.updateStats();
            }
            handleInvalidScan(reason, barcode, duplicate = false) {
                this.flashIndicator('red');
                this.playErrorSound();
                this.showError(`❌ ${reason}: ${barcode}`);
                if (duplicate) this.updateStats(true);
            }
            updateScanList() {
                const items = this.scanHistory.slice().reverse().map(item => `<div class="scan-item"><div>${item.barcode}</div><div class="scan-time">${item.time.toLocaleString('ko-KR')}</div></div>`).join('');
                this.scanList.innerHTML = items || '<p style="text-align:center;color:#666;">📋 스캔된 바코드가 여기에 표시됩니다</p>';
            }
            updateStats(dupTry = false) {
                const total = this.scanHistory.length + (dupTry ? 1 : 0);
                const valid = this.scannedCodes.size;
                const dup = total - valid;
                this.totalCount.textContent = total;
                this.validCount.textContent = valid;
                this.duplicateCount.textContent = dup;
            }
            stopScanning() {
                if (this.codeReader) this.codeReader.reset();
                if (this.mediaStream) this.mediaStream.getTracks().forEach(t => t.stop());
                this.video.srcObject = null;
                this.startBtn.style.display = 'block';
                this.stopBtn.style.display = 'none';
                this.showSuccess('⏹️ 스캔이 중지되었습니다');
            }
            clearData() { this.scannedCodes.clear(); this.scanHistory = []; this.updateScanList(); this.updateStats(); }
            playBeep(freq, dur) { try { const c=new (window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); const g=c.createGain(); o.connect(g); g.connect(c.destination); o.frequency.value=freq; g.gain.setValueAtTime(0.3,c.currentTime); g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+dur/1000); o.start(c.currentTime); o.stop(c.currentTime+dur/1000);}catch{} }
            playSuccessSound() { if(this.soundSetting.checked) this.playBeep(960,150);}  
            playErrorSound() { if(this.soundSetting.checked) this.playBeep(320,300);}  
            flashIndicator(color) { const cls=color==='green'?'light-green':'light-red'; this.scanIndicator.classList.add(cls); setTimeout(()=>this.scanIndicator.classList.remove(cls),1000);}  
            showError(msg) { this.errorMsg.textContent=msg; this.errorMsg.style.display='block'; setTimeout(()=>this.errorMsg.style.display='none',3000);}  
            showSuccess(msg) { this.successMsg.textContent=msg; this.successMsg.style.display='block'; setTimeout(()=>this.successMsg.style.display='none',2000);}  
            hideMessages() { this.errorMsg.style.display='none'; this.successMsg.style.display='none'; }
            toggleSettings() { this.settingsPanel.style.display = this.settingsPanel.style.display==='none'?'block':'none'; }
        }
        window.addEventListener('load',()=>new LibraryBarcodeScanner());
    </script>
</body>
</html>
