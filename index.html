<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ë„ì„œê´€ ì¥ì„œì ê²€ ìŠ¤ìºë„ˆ v1.9</title>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë³€ê²½ ì—†ìŒ) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container { max-width: 500px; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .scanner-area { position: relative; padding: 20px; background: #333; border-radius: 10px;}
        #video { width: 100%; max-width: 100%; border-radius: 10px; border: 3px solid #4CAF50; }
        .controls { padding: 20px; background: #fff; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .stats { display: flex; justify-content: space-around; padding: 15px 20px; background: #f5f5f5; border-top: 1px solid #ddd; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .stat-label { font-size: 12px; color: #666; }
        .scan-list { max-height: 300px; overflow-y: auto; padding: 20px; border-top: 1px solid #ddd; }
        .scan-item { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #4CAF50; font-family: monospace; font-size: 14px; }
        .scan-time { color: #666; font-size: 12px; }
        .settings { padding: 20px; border-top: 1px solid #ddd; background: #fafafa; }
        .setting-item { margin: 15px 0; }
        .setting-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .setting-item input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .message-box { padding: 10px; border-radius: 5px; margin: 10px 20px; display: none; }
        .error-message { background: #ffebee; color: #c62828; }
        .success-message { background: #e8f5e8; color: #2e7d32; }
        .toggle-btn { background: none; border: none; color: #2196F3; cursor: pointer; text-decoration: underline; margin: 10px 0; padding: 5px; display: block; margin-left: auto; margin-right: auto;}

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 10px; padding: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-content h3 { margin: 0 0 10px 0; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }

        .indicator-light { width: 20px; height: 20px; border-radius: 50%; background-color: #555; border: 2px solid #fff; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: all 0.3s ease; position: absolute; top: 50%; right: 20px; transform: translateY(-50%); }
        .light-green { background-color: #28a745; box-shadow: 0 0 15px #28a745; }
        .light-red { background-color: #dc3545; box-shadow: 0 0 15px #dc3545; }

        /* --- [ì¶”ê°€] ë°”ì½”ë“œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ --- */
        .grid-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 40%;
            max-height: 200px;
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            display: none; /* ìŠ¤ìº” ì‹œì‘ ì‹œ ë³´ì´ë„ë¡ ì„¤ì • */
        }
        .grid-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: red;
            box-shadow: 0 0 5px red;
            animation: laser-scan 2s infinite linear;
        }
        @keyframes laser-scan {
            0% { transform: translate(-50%, -100%); }
            50% { transform: translate(-50%, 100%); }
            100% { transform: translate(-50%, -100%); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="scanIndicator" class="indicator-light"></div>
            <h1>ğŸ“š ë„ì„œê´€ ì¥ì„œì ê²€ v1.9</h1>
            <p>ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</p>
        </div>
        
        <div class="scanner-area">
            <video id="video" autoplay muted playsinline></video>
            <div id="gridOverlay" class="grid-overlay"></div>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="btn btn-primary">ğŸ“· ìŠ¤ìº” ì‹œì‘</button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;">â¹ï¸ ìŠ¤ìº” ì¤‘ì§€</button>
            <button id="exportBtn" class="btn btn-secondary">ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
            <button id="clearBtn" class="btn btn-danger">ğŸ—‘ï¸ ëª©ë¡ ì§€ìš°ê¸°</button>
            <button id="settingsToggleBtn" class="toggle-btn">âš™ï¸ ì„¤ì •</button>
        </div>
        
        <div id="errorMsg" class="message-box error-message"></div>
        <div id="successMsg" class="message-box success-message"></div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">ğŸ“Š ì´ ìŠ¤ìº”</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="validCount">0</div>
                <div class="stat-label">âœ… ìœ íš¨</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="duplicateCount">0</div>
                <div class="stat-label">ğŸ”„ ì¤‘ë³µ</div>
            </div>
        </div>
        
        <div id="settingsPanel" class="settings" style="display: none;">
            <div class="setting-item">
                <label>ğŸ“ ë°”ì½”ë“œ ì‹œì‘ ë¬¸ì (ìœ íš¨ì„± ê²€ì‚¬):</label>
                <input type="text" id="prefixSetting" value="M" placeholder="ì˜ˆ: M, LIB, 20">
            </div>
            <div class="setting-item">
                <label>ğŸ”¢ ìµœì†Œ ë°”ì½”ë“œ ê¸¸ì´:</label>
                <input type="number" id="minLengthSetting" value="8" min="1">
            </div>
            <div class="setting-item">
                <label>ğŸ”Š ì•Œë¦¼ìŒ í™œì„±í™”:</label>
                <input type="checkbox" id="soundSetting" checked>
            </div>
            <div class="setting-item">
                <label>ğŸ”‹ ë°°í„°ë¦¬ ì ˆì•½ ëª¨ë“œ:</label>
                <input type="checkbox" id="batterySavingSetting" checked>
                <small style="color: #666; display: block; margin-top: 5px;">
                    í™œì„±í™”ì‹œ ìŠ¤ìº” ë¹ˆë„ë¥¼ ì¤„ì—¬ ë°œì—´ê³¼ ë°°í„°ë¦¬ ì†Œëª¨ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
                </small>
            </div>
            <div class="setting-item" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                 <small style="color: #666; display: block;">
                    <b>ì°¸ê³ :</b> ì›¹ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ê¸°ê¸°ì˜ ì˜¨ë„ë¥¼ ì§ì ‘ ì¸¡ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¥ì‹œê°„ ì‚¬ìš©ìœ¼ë¡œ ê¸°ê¸°ê°€ ëœ¨ê±°ì›Œì§€ë©´, ê³¼ì—´ ë°©ì§€ë¥¼ ìœ„í•´ ì ì‹œ ì‚¬ìš©ì„ ì¤‘ë‹¨í•´ì£¼ì„¸ìš”.
                </small>
            </div>
        </div>
        
        <div class="scan-list" id="scanList">
            <p style="text-align: center; color: #666;">ğŸ“‹ ìŠ¤ìº”ëœ ë°”ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <script>
        class LibraryBarcodeScanner {
            constructor() {
                this.scannedCodes = new Set();
                this.scanHistory = [];
                this.isScanning = false;
                this.codeReader = null;
                this.mediaStream = null;
                this.lastScannedCode = '';
                this.lastScanTime = 0;
                this.scanCooldown = 2000;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.initializeCodeReader();
            }
            
            initializeElements() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.gridOverlay = document.getElementById('gridOverlay');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.settingsToggleBtn = document.getElementById('settingsToggleBtn');
                this.settingsPanel = document.getElementById('settingsPanel');
                this.scanList = document.getElementById('scanList');
                this.totalCount = document.getElementById('totalCount');
                this.validCount = document.getElementById('validCount');
                this.duplicateCount = document.getElementById('duplicateCount');
                this.errorMsg = document.getElementById('errorMsg');
                this.successMsg = document.getElementById('successMsg');
                this.prefixSetting = document.getElementById('prefixSetting');
                this.minLengthSetting = document.getElementById('minLengthSetting');
                this.soundSetting = document.getElementById('soundSetting');
                this.batterySavingSetting = document.getElementById('batterySavingSetting');
                this.scanIndicator = document.getElementById('scanIndicator');
            }
            
            initializeEventListeners() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.exportBtn.addEventListener('click', () => this.exportData());
                this.clearBtn.addEventListener('click', () => this.showClearConfirmModal());
                this.settingsToggleBtn.addEventListener('click', () => this.toggleSettings());
            }
            
            initializeCodeReader() {
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.CODE_39,
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.EAN_8
                ]);
                this.codeReader = new ZXing.BrowserMultiFormatReader(hints);
            }
            
            async startScanning() {
                try {
                    this.hideMessages();
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    this.mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.mediaStream;
                    
                    this.video.onloadedmetadata = () => {
                        this.isScanning = true;
                        this.startBtn.style.display = 'none';
                        this.stopBtn.style.display = 'block';
                        this.gridOverlay.style.display = 'block'; // ê·¸ë¦¬ë“œ í‘œì‹œ
                        this.showSuccess('ğŸ“· ìŠ¤ìº”ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        this.activatePowerSavingMode();
                        requestAnimationFrame(this.scanFrame.bind(this));
                    };

                } catch (error) {
                    console.error('ì¹´ë©”ë¼ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    let userMessage = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.name;
                    if (error.name === 'NotAllowedError') {
                        userMessage = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    } else if (error.name === 'NotFoundError' || error.name === 'OverconstrainedError') {
                        userMessage = 'ì‚¬ìš© ê°€ëŠ¥í•œ í›„ë©´ ì¹´ë©”ë¼ë¥¼ ì°¾ê±°ë‚˜ ìš”ì²­í•œ í•´ìƒë„ë¥¼ ì§€ì›í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                    this.showError(userMessage);
                    this.stopScanning();
                }
            }

            // [í•µì‹¬ ê°œì„ ] ì„¸ë¡œ ëª¨ë“œ ì „ìš©ìœ¼ë¡œ ë‹¨ìˆœí™” ë° ì•ˆì •í™”ëœ ìŠ¤ìº” ë¡œì§
            scanFrame() {
                if (!this.isScanning) return;

                if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                    // ì„¸ë¡œ ëª¨ë“œì—ì„œëŠ” ì¹´ë©”ë¼ ì˜ìƒì´ ê°€ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ê°€ ë§ìœ¼ë¯€ë¡œ,
                    // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì˜ìƒì˜ ê°€ë¡œ/ì„¸ë¡œì™€ ë°˜ëŒ€ë¡œ ì„¤ì •í•˜ì—¬ 90ë„ íšŒì „ íš¨ê³¼ë¥¼ ì¤ë‹ˆë‹¤.
                    this.canvas.width = this.video.videoHeight;
                    this.canvas.height = this.video.videoWidth;
                    
                    // ìº”ë²„ìŠ¤ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ 90ë„ íšŒì „
                    this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.rotate(Math.PI / 2);
                    
                    // íšŒì „ëœ ì¤‘ì‹¬ì—ì„œ ë¹„ë””ì˜¤ë¥¼ ê·¸ë¦¼ (ì¤‘ì‹¬ì„ ë§ì¶”ê¸° ìœ„í•´ x, y ì¢Œí‘œë¥¼ ì¡°ì •)
                    this.ctx.drawImage(this.video, -this.video.videoWidth / 2, -this.video.videoHeight / 2);

                    try {
                        const result = this.codeReader.decodeFromCanvas(this.canvas);
                        if (result) {
                            this.processBarcodeResult(result.getText());
                        }
                    } catch (err) {
                        if (!(err instanceof ZXing.NotFoundException)) {
                            console.error('ìŠ¤ìº” ì˜¤ë¥˜:', err);
                        }
                    }
                }
                requestAnimationFrame(this.scanFrame.bind(this));
            }
            
            activatePowerSavingMode() {
                if (this.scanHistory.length === 0) {
                    setTimeout(() => {
                        this.showInfo('ğŸ’¡ ë°°í„°ë¦¬ ì ˆì•½ íŒ: í™”ë©´ ë°ê¸°ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”');
                    }, 3000);
                }
            }

            processBarcodeResult(barcode) {
                const now = Date.now();
                const currentCooldown = this.batterySavingSetting.checked ? this.scanCooldown : 1000;
                
                if (barcode === this.lastScannedCode && (now - this.lastScanTime) < currentCooldown) {
                    return;
                }
                
                this.lastScannedCode = barcode;
                this.lastScanTime = now;
                
                const prefix = this.prefixSetting.value.trim();
                const minLength = parseInt(this.minLengthSetting.value);
                
                if (prefix && !barcode.startsWith(prefix)) {
                    this.handleInvalidScan(`ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì‹œì‘ ë¬¸ì (${prefix}ë¡œ ì‹œì‘í•´ì•¼ í•¨)`, barcode);
                    return;
                }
                
                if (barcode.length < minLength) {
                    this.handleInvalidScan(`ë°”ì½”ë“œ ê¸¸ì´ê°€ ë„ˆë¬´ ì§§ìŒ (ìµœì†Œ ${minLength}ì)`, barcode);
                    return;
                }
                
                if (this.scannedCodes.has(barcode)) {
                    this.handleInvalidScan(`ì¤‘ë³µëœ ë°”ì½”ë“œ`, barcode, true);
                    return;
                }
                
                this.handleValidScan(barcode, now);
            }

            handleInvalidScan(reason, barcode, isDuplicate = false) {
                this.playErrorSound();
                this.flashIndicator('red');
                this.showError(`âŒ ${reason}: ${barcode}`);
                if (isDuplicate) {
                    this.updateStats(true);
                }
            }

            handleValidScan(barcode, now) {
                const timeString = new Date(now).toLocaleString('ko-KR');
                this.scannedCodes.add(barcode);
                this.scanHistory.push({
                    barcode: barcode,
                    timestamp: new Date(now),
                    timeString: timeString
                });
                
                this.playSuccessSound();
                this.flashIndicator('green');
                this.updateScanList();
                this.updateStats();
                this.showSuccess(`âœ… ìŠ¤ìº” ì™„ë£Œ: ${barcode}`);
            }
            
            stopScanning() {
                this.isScanning = false;
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                }
                this.video.srcObject = null;
                this.mediaStream = null;
                this.gridOverlay.style.display = 'none'; // ê·¸ë¦¬ë“œ ìˆ¨ê¹€

                this.startBtn.style.display = 'block';
                this.stopBtn.style.display = 'none';
                if(!this.errorMsg.style.display || this.errorMsg.style.display === 'none') {
                    this.showSuccess('â¹ï¸ ìŠ¤ìº”ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            }
            
            updateScanList() {
                if (this.scanHistory.length === 0) {
                    this.scanList.innerHTML = '<p style="text-align: center; color: #666;">ğŸ“‹ ìŠ¤ìº”ëœ ë°”ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>';
                    return;
                }
                
                this.scanList.innerHTML = this.scanHistory
                    .slice(-100)
                    .reverse()
                    .map(item => `
                        <div class="scan-item">
                            <div>${item.barcode}</div>
                            <div class="scan-time">â° ${item.timeString}</div>
                        </div>
                    `).join('');
            }
            
            updateStats(isDuplicateAttempt = false) {
                const totalScans = this.scanHistory.length + (isDuplicateAttempt ? 1 : 0);
                const validScans = this.scannedCodes.size;
                const duplicateScans = totalScans - validScans;

                this.totalCount.textContent = totalScans;
                this.validCount.textContent = validScans;
                this.duplicateCount.textContent = duplicateScans;
            }
            
            exportData() {
                if (this.scanHistory.length === 0) {
                    this.showError('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const csvContent = [
                    'ë°”ì½”ë“œ,ìŠ¤ìº”ì‹œê°„,ë‚ ì§œ,ì‹œê°„',
                    ...this.scanHistory.map(item => 
                        `"${item.barcode}","${item.timeString}","${item.timestamp.toLocaleDateString('ko-KR')}","${item.timestamp.toLocaleTimeString('ko-KR')}"`
                    )
                ].join('\n');
                
                this.showExportModal(csvContent);
            }
            
            showExportModal(csvContent) {
                const modalHTML = `
                    <div class="modal-overlay" id="exportModal">
                        <div class="modal-content">
                            <h3>ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                            <p style='font-size: 12px; color: #666; text-align: center; margin-bottom: 15px;'>ğŸ’¡ ìŠ¤ë§ˆíŠ¸í°ì—ì„œëŠ” 'ê³µìœ í•˜ê¸°' ë˜ëŠ” 'í´ë¦½ë³´ë“œ ë³µì‚¬'ë¥¼ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•©ë‹ˆë‹¤.</p>
                            <div style="margin-bottom: 15px;">
                                <button id="copyBtn" class="btn btn-primary">ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬</button>
                                <button id="downloadBtn" class="btn btn-secondary">ğŸ’¾ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
                                <button id="shareBtn" class="btn" style="background: #FF9800; color: white;">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“„ CSV ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:</label>
                                <textarea readonly style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px; resize: none;">${csvContent}</textarea>
                            </div>
                            <div class="modal-buttons">
                                <button id="closeExportModalBtn" class="btn btn-danger" style="width: 100%;">âŒ ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                document.getElementById('copyBtn').addEventListener('click', (e) => this.copyToClipboard(csvContent, e.target));
                document.getElementById('downloadBtn').addEventListener('click', (e) => this.downloadCSV(csvContent, e.target));
                document.getElementById('shareBtn').addEventListener('click', (e) => this.shareData(csvContent, e.target));
                document.getElementById('closeExportModalBtn').addEventListener('click', () => this.closeModal('exportModal'));
                document.getElementById('exportModal').addEventListener('click', (e) => {
                    if (e.target.id === 'exportModal') this.closeModal('exportModal');
                });
            }

            showClearConfirmModal() {
                const modalHTML = `
                    <div class="modal-overlay" id="clearConfirmModal">
                        <div class="modal-content">
                            <h3>ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ í™•ì¸</h3>
                            <p>ì •ë§ë¡œ ëª¨ë“  ìŠ¤ìº” ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <div class="modal-buttons">
                                <button id="confirmClearBtn" class="btn btn-danger">ì‚­ì œ</button>
                                <button id="cancelClearBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                document.getElementById('confirmClearBtn').addEventListener('click', () => {
                    this.clearData();
                    this.closeModal('clearConfirmModal');
                });
                document.getElementById('cancelClearBtn').addEventListener('click', () => this.closeModal('clearConfirmModal'));
                document.getElementById('clearConfirmModal').addEventListener('click', (e) => {
                    if (e.target.id === 'clearConfirmModal') this.closeModal('clearConfirmModal');
                });
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.remove();
            }
            
            async copyToClipboard(csvContent, button) {
                try {
                    await navigator.clipboard.writeText(csvContent);
                    this.showTemporarySuccess(button, 'âœ… ë³µì‚¬ë¨!');
                    this.showSuccess('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                } catch (error) {
                    this.showError('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                }
            }
            
            downloadCSV(csvContent, button) {
                try {
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    const now = new Date();
                    const year = now.getFullYear().toString().slice(-2);
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const count = this.scanHistory.length.toString().padStart(3, '0');

                    link.href = url;
                    link.download = `${year}${month}${day}_${hours}${minutes}_${count}.csv`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    this.showTemporarySuccess(button, 'âœ… ë‹¤ìš´ë¡œë“œ!');
                    this.showSuccess(`ğŸ’¾ ${this.scanHistory.length}ê°œ í•­ëª©ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤`);
                } catch (error) {
                    this.showError('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.');
                }
            }
            
            async shareData(csvContent, button) {
                if (!navigator.share) {
                    this.showError('ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                    return;
                }
                const fileName = `ì¥ì„œì ê²€_${new Date().toISOString().slice(0,10)}.csv`;
                const file = new File(['\uFEFF' + csvContent], fileName, { type: 'text/csv' });
                try {
                    await navigator.share({
                        title: 'ğŸ“š ë„ì„œê´€ ì¥ì„œì ê²€ ê²°ê³¼',
                        text: `ì¥ì„œì ê²€ ê²°ê³¼ (${this.scanHistory.length}ê°œ í•­ëª©)`,
                        files: [file]
                    });
                    this.showTemporarySuccess(button, 'âœ… ê³µìœ ë¨!');
                } catch (error) {
                    this.showError('ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.');
                }
            }
            
            showTemporarySuccess(button, message) {
                const originalText = button.textContent;
                const originalBg = button.style.backgroundColor;
                button.textContent = message;
                button.style.background = '#4CAF50';
                button.disabled = true;
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = originalBg;
                    button.disabled = false;
                }, 2000);
            }
            
            clearData() {
                this.scannedCodes.clear();
                this.scanHistory = [];
                this.updateScanList();
                this.updateStats();
                this.showSuccess('ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
            
            playBeep(frequency, duration) {
                if (!this.soundSetting.checked) return;
                try {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    oscillator.frequency.value = frequency;
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + duration / 1000);
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + duration / 1000);
                } catch (e) {
                    console.error("AudioContextë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.", e);
                }
            }
            playSuccessSound() { this.playBeep(960, 150); }
            playErrorSound() { this.playBeep(320, 300); }

            flashIndicator(color) {
                if (!this.scanIndicator) return;
                const className = color === 'green' ? 'light-green' : 'light-red';
                this.scanIndicator.classList.add(className);
                setTimeout(() => {
                    this.scanIndicator.classList.remove(className);
                }, 1000);
            }

            showError(message) { this.showMessage(this.errorMsg, message, 3000); }
            showSuccess(message) { this.showMessage(this.successMsg, message, 2000); }
            showInfo(message) { this.showMessage(this.successMsg, message, 4000, '#e3f2fd', '#1565c0'); }

            showMessage(element, message, duration, bg = null, color = null) {
                const originalBg = element.style.background;
                const originalColor = element.style.color;
                
                element.textContent = message;
                if(bg) element.style.background = bg;
                if(color) element.style.color = color;

                element.style.display = 'block';
                (element === this.errorMsg ? this.successMsg : this.errorMsg).style.display = 'none';
                
                setTimeout(() => {
                    element.style.display = 'none';
                    if(bg) element.style.background = originalBg;
                    if(color) element.style.color = originalColor;
                }, duration);
            }
            
            hideMessages() {
                this.errorMsg.style.display = 'none';
                this.successMsg.style.display = 'none';
            }

            toggleSettings() {
                const panel = this.settingsPanel;
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        window.addEventListener('load', () => {
            const scanner = new LibraryBarcodeScanner();
            scanner.updateStats();
        });
        
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        */
    </script>
</body>
</html>
