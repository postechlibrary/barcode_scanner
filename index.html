<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 도서관 장서점검 스캐너</title>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .scanner-area {
            position: relative;
            padding: 20px;
        }
        
        #video {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            border: 3px solid #4CAF50;
        }
        
        .controls {
            padding: 0 20px 20px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #1976D2;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 15px 20px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .scan-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        
        .scan-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            font-family: monospace;
            font-size: 14px;
        }
        
        .scan-time {
            color: #666;
            font-size: 12px;
        }
        
        .settings {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: #fafafa;
        }
        
        .setting-item {
            margin: 10px 0;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .setting-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .toggle-btn {
            background: none;
            border: none;
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 도서관 장서점검</h1>
            <p>바코드 스캐너</p>
        </div>
        
        <div class="scanner-area">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="btn btn-primary">📷 스캔 시작</button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;">⏹️ 스캔 중지</button>
            <button id="exportBtn" class="btn btn-secondary">💾 데이터 내보내기</button>
            <button id="clearBtn" class="btn btn-danger">🗑️ 목록 지우기</button>
            <button class="toggle-btn" onclick="toggleSettings()">⚙️ 설정</button>
        </div>
        
        <div class="error-message" id="errorMsg"></div>
        <div class="success-message" id="successMsg"></div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">📊 총 스캔</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="validCount">0</div>
                <div class="stat-label">✅ 유효</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="duplicateCount">0</div>
                <div class="stat-label">🔄 중복</div>
            </div>
        </div>
        
        <div id="settingsPanel" class="settings" style="display: none;">
            <div class="setting-item">
                <label>📝 바코드 시작 문자 (유효성 검사):</label>
                <input type="text" id="prefixSetting" value="M" placeholder="예: M, LIB, 20">
            </div>
            <div class="setting-item">
                <label>🔢 최소 바코드 길이:</label>
                <input type="number" id="minLengthSetting" value="8" min="1">
            </div>
            <div class="setting-item">
                <label>🔊 알림음 활성화:</label>
                <input type="checkbox" id="soundSetting" checked>
            </div>
        </div>
        
        <div class="scan-list" id="scanList">
            <p style="text-align: center; color: #666;">📋 스캔된 바코드가 여기에 표시됩니다</p>
        </div>
    </div>

    <script>
        class LibraryBarcodeScanner {
            constructor() {
                this.scannedCodes = new Set();
                this.scanHistory = [];
                this.duplicateAttempts = 0; // 중복 시도 횟수 추가
                this.isScanning = false;
                this.codeReader = null;
                this.stream = null;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.initializeCodeReader();
            }
            
            initializeElements() {
                this.video = document.getElementById('video');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.scanList = document.getElementById('scanList');
                this.totalCount = document.getElementById('totalCount');
                this.validCount = document.getElementById('validCount');
                this.duplicateCount = document.getElementById('duplicateCount');
                this.errorMsg = document.getElementById('errorMsg');
                this.successMsg = document.getElementById('successMsg');
                this.prefixSetting = document.getElementById('prefixSetting');
                this.minLengthSetting = document.getElementById('minLengthSetting');
                this.soundSetting = document.getElementById('soundSetting');
            }
            
            initializeEventListeners() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.exportBtn.addEventListener('click', () => this.exportData());
                this.clearBtn.addEventListener('click', () => this.clearData());
            }
            
            initializeCodeReader() {
                this.codeReader = new ZXing.BrowserMultiFormatReader();
            }
            
            async startScanning() {
                try {
                    this.hideMessages();
                    
                    // 이전 스캔이 있다면 정리
                    if (this.codeReader) {
                        this.codeReader.reset();
                    }
                    
                    this.isScanning = true;
                    this.startBtn.style.display = 'none';
                    this.stopBtn.style.display = 'block';
                    
                    // ZXing을 사용한 연속 바코드 스캔
                    this.codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                        if (result) {
                            this.processBarcodeResult(result.text);
                        }
                        // 에러는 바코드가 감지되지 않는 정상적인 상황이므로 무시
                    });
                    
                    this.showSuccess('📷 스캔이 시작되었습니다!');
                    
                } catch (error) {
                    this.showError('카메라 접근 실패: ' + error.message);
                    this.resetUI();
                }
            }
            
            async scanContinuously() {
                if (!this.isScanning) return;
                
                try {
                    const result = await this.codeReader.decodeOnceFromVideoDevice(undefined, 'video');
                    if (result) {
                        this.processBarcodeResult(result.text);
                    }
                } catch (error) {
                    // 바코드가 감지되지 않은 경우는 정상이므로 무시
                }
                
                // 연속 스캔을 위해 재귀 호출 (100ms 간격)
                if (this.isScanning) {
                    setTimeout(() => this.scanContinuously(), 100);
                }
            }
            
            processBarcodeResult(barcode) {
                const now = new Date();
                const timeString = now.toLocaleString('ko-KR');
                
                // 유효성 검사
                const prefix = this.prefixSetting.value.trim();
                const minLength = parseInt(this.minLengthSetting.value);
                
                let isValid = true;
                let errorReason = '';
                
                if (prefix && !barcode.startsWith(prefix)) {
                    isValid = false;
                    errorReason = `올바르지 않은 시작 문자 (${prefix}로 시작해야 함)`;
                }
                
                if (barcode.length < minLength) {
                    isValid = false;
                    errorReason = `바코드 길이가 너무 짧음 (최소 ${minLength}자)`;
                }
                
                if (!isValid) {
                    this.playErrorSound();
                    this.showError(`❌ ${errorReason}: ${barcode}`);
                    return;
                }
                
                // 중복 검사
                const isDuplicate = this.scannedCodes.has(barcode);
                
                if (isDuplicate) {
                    this.duplicateAttempts++;
                    this.playErrorSound();
                    this.showError(`🔄 중복된 바코드: ${barcode}`);
                    this.updateStats();
                    return;
                }
                
                // 성공적으로 스캔됨
                this.scannedCodes.add(barcode);
                this.scanHistory.push({
                    barcode: barcode,
                    timestamp: now,
                    timeString: timeString
                });
                
                this.playSuccessSound();
                this.updateScanList();
                this.updateStats();
                this.showSuccess(`✅ 스캔 완료: ${barcode}`);
            }
            
            stopScanning() {
                this.isScanning = false;
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                
                this.startBtn.style.display = 'block';
                this.stopBtn.style.display = 'none';
                
                this.showSuccess('⏹️ 스캔이 중지되었습니다');
            }
            
            updateScanList() {
                if (this.scanHistory.length === 0) {
                    this.scanList.innerHTML = '<p style="text-align: center; color: #666;">📋 스캔된 바코드가 여기에 표시됩니다</p>';
                    return;
                }
                
                this.scanList.innerHTML = this.scanHistory
                    .slice(-50) // 최근 50개만 표시
                    .reverse()
                    .map(item => `
                        <div class="scan-item">
                            <div>${item.barcode}</div>
                            <div class="scan-time">⏰ ${item.timeString}</div>
                        </div>
                    `).join('');
            }
            
            updateStats() {
                this.totalCount.textContent = this.scanHistory.length;
                this.validCount.textContent = this.scannedCodes.size;
                this.duplicateCount.textContent = this.scanHistory.length - this.scannedCodes.size;
            }
            
            exportData() {
                if (this.scanHistory.length === 0) {
                    this.showError('내보낼 데이터가 없습니다');
                    return;
                }
                
                const csvContent = [
                    '바코드,스캔시간,날짜,시간',
                    ...this.scanHistory.map(item => 
                        `"${item.barcode}","${item.timeString}","${item.timestamp.toLocaleDateString('ko-KR')}","${item.timestamp.toLocaleTimeString('ko-KR')}"`
                    )
                ].join('\n');
                
                // 모바일에서 더 안정적인 방법으로 데이터 내보내기
                this.showExportModal(csvContent);
            }
            
            showExportModal(csvContent) {
                // 기존 모달이 있으면 제거
                const existingModal = document.getElementById('exportModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 모달 생성
                const modal = document.createElement('div');
                modal.id = 'exportModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 10px;
                        padding: 20px;
                        width: 100%;
                        max-width: 500px;
                        max-height: 80vh;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                    ">
                        <h3 style="margin: 0 0 15px 0; text-align: center;">📊 데이터 내보내기</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <button onclick="scanner.copyToClipboard('${csvContent.replace(/'/g, "\\'")}', this)" 
                                    style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; margin: 5px 0; cursor: pointer;">
                                📋 클립보드에 복사
                            </button>
                            
                            <button onclick="scanner.downloadCSV('${csvContent.replace(/'/g, "\\'")}', this)" 
                                    style="width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 5px; margin: 5px 0; cursor: pointer;">
                                💾 파일 다운로드
                            </button>
                            
                            <button onclick="scanner.shareData('${csvContent.replace(/'/g, "\\'")}', this)" 
                                    style="width: 100%; padding: 12px; background: #FF9800; color: white; border: none; border-radius: 5px; margin: 5px 0; cursor: pointer;">
                                📤 공유하기
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">📄 CSV 데이터 미리보기:</label>
                            <textarea id="csvPreview" readonly style="
                                width: 100%;
                                height: 200px;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-family: monospace;
                                font-size: 12px;
                                resize: none;
                            ">${csvContent}</textarea>
                        </div>
                        
                        <button onclick="scanner.closeExportModal()" 
                                style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ❌ 닫기
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 모달 외부 클릭시 닫기
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeExportModal();
                    }
                });
            }
            
            async copyToClipboard(csvContent, button) {
                try {
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(csvContent);
                        this.showTemporarySuccess(button, '✅ 복사됨!');
                        this.showSuccess('📋 클립보드에 복사되었습니다');
                    } else {
                        // 구형 브라우저 대안
                        const textArea = document.getElementById('csvPreview');
                        textArea.select();
                        textArea.setSelectionRange(0, 99999);
                        document.execCommand('copy');
                        this.showTemporarySuccess(button, '✅ 복사됨!');
                        this.showSuccess('📋 클립보드에 복사되었습니다');
                    }
                } catch (error) {
                    this.showError('클립보드 복사 실패. 텍스트를 수동으로 선택해서 복사해주세요.');
                }
            }
            
            downloadCSV(csvContent, button) {
                try {
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    link.href = url;
                    link.download = `장서점검_${new Date().toISOString().slice(0,10)}.csv`;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    this.showTemporarySuccess(button, '✅ 다운로드!');
                    this.showSuccess(`💾 ${this.scanHistory.length}개 항목이 다운로드되었습니다`);
                } catch (error) {
                    this.showError('파일 다운로드 실패. 클립보드 복사를 이용해주세요.');
                }
            }
            
            shareData(csvContent, button) {
                if (navigator.share) {
                    const fileName = `장서점검_${new Date().toISOString().slice(0,10)}.csv`;
                    navigator.share({
                        title: '📚 도서관 장서점검 결과',
                        text: `장서점검 결과 (${this.scanHistory.length}개 항목)\n\n${csvContent}`,
                        files: [new File(['\uFEFF' + csvContent], fileName, { type: 'text/csv' })]
                    }).then(() => {
                        this.showTemporarySuccess(button, '✅ 공유됨!');
                    }).catch(() => {
                        // 파일 공유 실패시 텍스트만 공유
                        navigator.share({
                            title: '📚 도서관 장서점검 결과',
                            text: `장서점검 결과 (${this.scanHistory.length}개 항목)\n\n${csvContent.substring(0, 1000)}...`
                        }).then(() => {
                            this.showTemporarySuccess(button, '✅ 공유됨!');
                        }).catch(() => {
                            this.showError('공유 기능을 사용할 수 없습니다. 클립보드 복사를 이용해주세요.');
                        });
                    });
                } else {
                    this.showError('공유 기능을 지원하지 않는 브라우저입니다. 클립보드 복사를 이용해주세요.');
                }
            }
            
            showTemporarySuccess(button, message) {
                const originalText = button.textContent;
                button.textContent = message;
                button.style.background = '#4CAF50';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }
            
            closeExportModal() {
                const modal = document.getElementById('exportModal');
                if (modal) {
                    modal.remove();
                }
            }
            
            clearData() {
                if (confirm('🗑️ 모든 스캔 데이터를 삭제하시겠습니까?')) {
                    this.scannedCodes.clear();
                    this.scanHistory = [];
                    this.updateScanList();
                    this.updateStats();
                    this.showSuccess('🗑️ 모든 데이터가 삭제되었습니다');
                }
            }
            
            playSuccessSound() {
                if (this.soundSetting.checked) {
                    this.playBeep(800, 100);
                }
            }
            
            playErrorSound() {
                if (this.soundSetting.checked) {
                    this.playBeep(400, 200);
                }
            }
            
            playBeep(frequency, duration) {
                if (typeof(AudioContext) !== "undefined" || typeof(webkitAudioContext) !== "undefined") {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    
                    oscillator.frequency.value = frequency;
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + duration / 1000);
                    
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + duration / 1000);
                }
            }
            
            showError(message) {
                this.errorMsg.textContent = message;
                this.errorMsg.style.display = 'block';
                this.successMsg.style.display = 'none';
                setTimeout(() => this.hideMessages(), 3000);
            }
            
            showSuccess(message) {
                this.successMsg.textContent = message;
                this.successMsg.style.display = 'block';
                this.errorMsg.style.display = 'none';
                setTimeout(() => this.hideMessages(), 2000);
            }
            
            hideMessages() {
                this.errorMsg.style.display = 'none';
                this.successMsg.style.display = 'none';
            }
        }
        
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // 앱 초기화
        let scanner;
        
        window.addEventListener('load', () => {
            scanner = new LibraryBarcodeScanner();
            scanner.updateStats(); // 초기 통계 표시
        });
        
        // PWA 지원을 위한 서비스 워커 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
